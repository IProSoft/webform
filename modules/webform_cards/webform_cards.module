<?php

use Drupal\Core\Hook\Attribute\LegacyHook;
use Drupal\webform_cards\Hook\WebformCardsHooks;
use Drupal\Component\Utility\Html;
use Drupal\Component\Utility\NestedArray;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\EventSubscriber\MainContentViewSubscriber;
use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;
use Drupal\Core\Render\Element\RenderElementBase;
use Drupal\Core\Template\Attribute;
use Drupal\Core\Url;
use Drupal\webform\Element\WebformMessage;
use Drupal\webform\Utility\WebformArrayHelper;
use Drupal\webform\Utility\WebformDialogHelper;
use Drupal\webform\Utility\WebformElementHelper;
use Drupal\webform\WebformInterface;
use Drupal\webform\WebformSubmissionInterface;

/**
 * Implements hook_entity_base_field_info().
 */
#[LegacyHook]
function webform_cards_entity_base_field_info(EntityTypeInterface $entity_type) {
  return \Drupal::service(WebformCardsHooks::class)->entityBaseFieldInfo($entity_type);
}

/* ************************************************************************** */
// Menu hook.
/* ************************************************************************** */

/**
 * Implements hook_menu_local_actions_alter().
 */
#[LegacyHook]
function webform_cards_menu_local_actions_alter(&$local_actions) {
  \Drupal::service(WebformCardsHooks::class)->menuLocalActionsAlter($local_actions);
}

/**
 * Implements hook_preprocess_menu_local_action().
 *
 * @see webform_ui_preprocess_menu_local_action()
 */
function webform_cards_preprocess_menu_local_action(&$variables) {
  if (\Drupal::routeMatch()->getRouteName() !== 'entity.webform.edit_form') {
    return;
  }

  if ($variables['link']['#url']->getRouteName() === 'entity.webform_ui.element.add_card') {
    $variables['link']['#options']['attributes']['class'][] = 'button--secondary';
  }
}

/* ************************************************************************** */
// Entity hook.
/* ************************************************************************** */

/**
 * Implements hook_ENTITY_TYPE_presave() for webform_submission entities.
 */
#[LegacyHook]
function webform_cards_webform_submission_presave(WebformSubmissionInterface $webform_submission) {
  \Drupal::service(WebformCardsHooks::class)->webformSubmissionPresave($webform_submission);
}

/* ************************************************************************** */
// Form alter hooks.
/* ************************************************************************** */

/**
 * Implements hook_webform_submission_form_alter().
 */
#[LegacyHook]
function webform_cards_webform_submission_form_alter(array &$form, FormStateInterface $form_state, $form_id)
{
    return \Drupal::service(WebformCardsHooks::class)->webformSubmissionFormAlter($form, $form_state, $form_id);
}

/**
 * Entity form builder to set the current card for a webform submission.
 */
function webform_cards_webform_submission_builder($entity_type, WebformSubmissionInterface $entity, &$form, FormStateInterface $form_state) {
  $entity->set('current_card', $form_state->getValue('current_card'));
}

/**
 * Implements hook_form_FORM_ID_alter() for webform UI and source edit form.
 *
 * @see \Drupal\webform_ui\WebformUiEntityElementsForm
 */
#[LegacyHook]
function webform_cards_form_webform_edit_form_alter(array &$form, FormStateInterface $form_state)
{
    return \Drupal::service(WebformCardsHooks::class)->formWebformEditFormAlter($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for webform configuration:forms.
 *
 * @see \Drupal\webform\Form\AdminConfig\WebformAdminConfigFormsForm
 * @see /admin/structure/webform/config
 */
#[LegacyHook]
function webform_cards_form_webform_admin_config_forms_form_alter(array &$form, FormStateInterface $form_state) {
  \Drupal::service(WebformCardsHooks::class)->formWebformAdminConfigFormsFormAlter($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for webform configuration:elements.
 *
 * @see \Drupal\webform\Form\AdminConfig\WebformAdminConfigElementsForm
 * @see /admin/structure/webform/config/elements
 */
#[LegacyHook]
function webform_cards_form_webform_admin_config_elements_form_alter(array &$form, FormStateInterface $form_state) {
  \Drupal::service(WebformCardsHooks::class)->formWebformAdminConfigElementsFormAlter($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for webform settings:form.
 *
 * @see \Drupal\webform\EntitySettings\WebformEntitySettingsFormForm
 * @see /admin/structure/webform/manage/{webform}/settings
 */
#[LegacyHook]
function webform_cards_form_webform_settings_form_alter(array &$form, FormStateInterface $form_state)
{
    return \Drupal::service(WebformCardsHooks::class)->formWebformSettingsFormAlter($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for webform settings form.
 *
 * @see \Drupal\webform\EntitySettings\WebformEntitySettingsGeneralForm
 * @see /admin/structure/webform/manage/{webform}/settings/form
 */
#[LegacyHook]
function webform_cards_form_webform_settings_form_form_alter(array &$form, FormStateInterface $form_state)
{
    \Drupal::service(WebformCardsHooks::class)->formWebformSettingsFormFormAlter($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for webform settings submissions.
 *
 * @see \Drupal\webform\EntitySettings\WebformEntitySettingsSubmissionsForm
 * @see /admin/structure/webform/manage/{webform}/settings/form
 */
#[LegacyHook]
function webform_cards_form_webform_settings_submissions_form_alter(array &$form, FormStateInterface $form_state)
{
    \Drupal::service(WebformCardsHooks::class)->formWebformSettingsSubmissionsFormAlter($form, $form_state);
}

/**
 * Determine if the form state's related webform has cards.
 *
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The current state of the form.
 *
 * @return bool
 *   TRUE if the form states entity webform has cards.
 */
function _webform_cards_form_state_has_cards(FormStateInterface $form_state) {
  /** @var \Drupal\Core\Entity\EntityFormInterface $form_object */
  $form_object = $form_state->getFormObject();

  /** @var \Drupal\webform\WebformInterface $entity */
  $webform = $form_object->getEntity();

  /** @var \Drupal\webform_cards\WebformCardsManagerInterface $webform_cards_manager */
  $webform_cards_manager = \Drupal::service('webform_cards.manager');

  // Check if the webform has cards.
  return $webform_cards_manager->hasCards($webform);
}

/**
 * Alter webform wizard configuration and settings form elements.
 *
 * @param array &$form
 *   The form to be altered.
 * @param array $elements
 *   The elements to be altered.
 */
function _webform_cards_form_alter_elements(array &$form, array $elements) {
  foreach ($elements as $container_key => $container) {
    foreach ($container as $key => $element) {
      if (!isset($form[$container_key][$key])) {
        continue;
      }

      if (WebformElementHelper::property($key)) {
        $form[$container_key][$key] = $element;
      }
      elseif (is_array($container)) {
        $form[$container_key][$key] = $element + $form[$container_key][$key];
      }
    }
  }
}

/* ************************************************************************** */
// Theming.
/* ************************************************************************** */

/**
 * Implements hook_theme().
 */
#[LegacyHook]
function webform_cards_theme()
{
    return \Drupal::service(WebformCardsHooks::class)->theme();
}

/**
 * Prepares variables for webform section element templates.
 *
 * Default template: webform-section.html.twig.
 *
 * Copied from: template_preprocess_fieldset()
 *
 * @param array $variables
 *   An associative array containing:
 *   - element: An associative array containing the properties of the element.
 *     Properties used: #attributes, #children, #description, #id, #title,
 *     #value.
 */
function template_preprocess_webform_card(array &$variables) {
  $element = $variables['element'];
  Element::setAttributes($element, ['id']);
  RenderElementBase::setAttributes($element);
  $variables['attributes'] = $element['#attributes'] ?? [];
  $variables['prefix'] = $element['#field_prefix'] ?? NULL;
  $variables['suffix'] = $element['#field_suffix'] ?? NULL;
  $variables['title_display'] = $element['#title_display'] ?? NULL;
  $variables['title_tag'] = $element['#title_tag'] ?? 'h2';
  $variables['title_attributes'] = $element['#title_attributes'] ?? [];
  $variables['children'] = $element['#children'];

  // Allow markup in title.
  if (isset($element['#title']) && $element['#title'] !== '') {
    $variables['title'] = ['#markup' => $element['#title']];
  }

  // Add 'visually-hidden' class to title attributes.
  if ($variables['title_display'] === 'invisible') {
    $variables['title_attributes']['class'][] = 'visually-hidden';
  }
  $variables['title_attributes'] = new Attribute($variables['title_attributes']);

  if (!empty($element['#description'])) {
    $description_id = $element['#attributes']['id'] . '--description';
    $description_attributes['id'] = $description_id;
    $variables['description']['attributes'] = new Attribute($description_attributes);
    $variables['description']['content'] = $element['#description'];

    // Add the description's id to the fieldset aria attributes.
    $variables['attributes']['aria-describedby'] = $description_id;
  }

  // Setup description, help, and more.
  _webform_preprocess_element($variables);
}

/**
 * Implements hook_preprocess_webform_confirmation() for webform cards.
 */
function webform_cards_preprocess_webform_confirmation(array &$variables) {
  /** @var \Drupal\webform\WebformInterface $webform */
  $webform = $variables['webform'];
  /** @var \Drupal\webform\WebformSubmissionInterface $webform_submission */
  $webform_submission = $variables['webform_submission'];

  /** @var \Drupal\webform_cards\WebformCardsManagerInterface $webform_cards_manager */
  $webform_cards_manager = \Drupal::service('webform_cards.manager');

  // Check if the webform has cards.
  $has_cards = $webform_cards_manager->hasCards($webform);
  if (!$has_cards) {
    return;
  }

  // Set progress.
  $pages = $webform_cards_manager->buildPages($webform);
  $settings = $webform->getSettings();
  if ($pages && $settings['wizard_confirmation'] && ($settings['wizard_progress_bar'] || $settings['wizard_progress_pages'] || $settings['wizard_progress_percentage'])) {
    $variables['progress'] = [
      '#theme' => 'webform_progress',
      '#webform' => $webform,
      '#webform_submission' => $webform_submission,
      '#current_page' => WebformInterface::PAGE_CONFIRMATION,
      '#pages' => $webform_cards_manager->applyConditions($pages, $webform_submission),
    ];
  }
}
