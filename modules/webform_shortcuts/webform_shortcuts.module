<?php

/**
 * @file
 * Provides keyboard shortcuts to create and save webform elements.
 */

use Drupal\Core\Hook\Attribute\LegacyHook;
use Drupal\webform_shortcuts\Hook\WebformShortcutsHooks;
use Drupal\Core\Cache\CacheableMetadata;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\webform\Utility\WebformTextHelper;

/**
 * Implements hook_webform_libraries_info().
 */
#[LegacyHook]
function webform_shortcuts_webform_libraries_info() {
  return \Drupal::service(WebformShortcutsHooks::class)->webformLibrariesInfo();
}

/**
 * Implements hook_preprocess_block().
 */
function webform_shortcuts_preprocess_block(&$variables) {
  if ($variables['plugin_id'] !== 'local_actions_block') {
    return;
  }

  if (\Drupal::routeMatch()->getRouteName() !== 'entity.webform.edit_form') {
    return;
  }

  // Get shortcuts settings.
  $config = \Drupal::config('webform_shortcuts.settings');
  $cache = CacheableMetadata::createFromObject($config);

  // Shortcuts.
  // phpcs:disable Squiz.Arrays.ArrayDeclaration.KeySpecified
  $shortcuts = [
    '--',
    'add_element' => t('Add element'),
    'add_page' => t('Add page'),
    'add_layout' => t('Add layout'),
    '--',
    'save_elements' => t('Save element or elements'),
    'reset_elements' => t('Reset elements'),
    '--',
    'toggle_weights' => t('Show/hide row weights'),
    '--',
  ];
  // phpcs:enable Squiz.Arrays.ArrayDeclaration.KeySpecified

  $items = [];
  $last_shortcut = '';
  foreach ($shortcuts as $name => $task) {
    if ($task === '--') {
      if ($last_shortcut !== $task) {
        $items[] = ['#markup' => '<hr/>'];
      }
      $last_shortcut = $task;
    }
    else {
      $shortcut = $config->get($name);
      if ($shortcut) {
        $t_args = [
          '@shortcut' => strtoupper($shortcut),
          '@task' => $task,
        ];
        $items[] = [
          '#markup' => t('@shortcut = @task', $t_args),
          '#suffix' => '<br/>',
        ];
        $last_shortcut = $name;
      }
    }
  }

  $variables['content']['help'] = [
    '#type' => 'webform_help',
    '#help_title' => t('Keyboard shortcuts'),
    '#help' => $items,
    '#weight' => 100,
  ];

  $variables['content']['help']['#attached']['library'][] = 'webform_shortcuts/webform_shortcuts';

  // Convert shortcuts PHP settings to camelCase JavaScript settings.
  $settings = [];
  $data = $config->getRawData();
  foreach ($data as $name => $value) {
    $settings[WebformTextHelper::snakeToCamel($name)] = $value;
  }
  $variables['content']['help']['#attached']['drupalSettings']['webform']['shortcuts'] = $settings;

  $cache->applyTo($variables['content']['help']);
}

/**
 * Implements hook_form_FORM_ID_alter() for admin config advanced form.
 */
#[LegacyHook]
function webform_shortcuts_form_webform_admin_config_advanced_form_alter(&$form, FormStateInterface $form_state) {
  \Drupal::service(WebformShortcutsHooks::class)->formWebformAdminConfigAdvancedFormAlter($form, $form_state);
}

/**
 * Submit callback to save the webform shortcuts setting.
 */
function _webform_shortcuts_form_webform_admin_config_advanced_form_submit($form, FormStateInterface $form_state) {
  \Drupal::configFactory()
    ->getEditable('webform_shortcuts.settings')
    ->setData($form_state->getValue('webform_shortcuts'))
    ->save();
}
